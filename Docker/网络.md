# Docker网络

## 1.docker内部网络原理

docker启动时会在主机上创建一个docker0的虚拟网桥，它会在挂载其上的接口之间进行转发，可以理解为一个交换机。并且docker0分配到一个ip地址和掩码，然后启动的容器都在这个网段内。

当创建一个docker容器时，会自动创建一对veth pair接口。在容器内为eth0，在docker内为vethXXX，用于容器和docker通信。

这样，加上docker0网桥，主机、docker、容器，三者之间的网络通信就完成了。

## 2.网络基础配置

### 2.1 端口映射
```
docker run -d -P training/webapp python app.py #-P自动映射
docker run -d -p 5000:5000 -p 3000:80 training/webapp python app.py #-p指定映射

docker run -d -p 127.0.0.1:5000:5000 training/webapp python app.py #加上主机

docker run -d -p 127.0.0.1::5000 training/webapp python app.py #任意端口映射，会自动分配

docker port web 5000 #查看端口
```

>PORTS一栏：0.0.0.49155->5000/tcp，即主机的高位端口49155映射到容器的5000。

>-p，小写，则必须指明端口。

>格式：ip:hostport:containerport 
| ip::containerport | hostport:containerport



### 2.2 容器互联

--link name:alias（name是要连接的容器的名称，alias是这个容器的别名）可以让容器之间更加安全地交互。它会在源和接受容器之间创建一个隧道，接受容器可以看到源容器的指定的信息。
```
sudo docker run -d --name db training/postgress

sudo docker rm -f web

sudo docker run -d -P --name web --link db:db training/webapp python app.py
```
Docker通过两种方式公开连接信息：
- 环境变量：env查看
- 更新/etc/hosts文件：cat /etc/hosts ping db测试。

## 3.高级网络配置

### 3.1 网络相关参数参数

Docker服务命令
```
-b BRIDGE：指定挂载的网桥
--icc=true|false：是否支持容器间通信
--ip-forward=true|false：启动net.ipv4.ip forward，即转发功能
--iptables=true|false：禁止docker添加iptables规则。
--mtu=BYTES：容器网络中的MTU

docker run时，并覆盖默认值
--dns=IP_ADDRESS：使用指定的DNS服务器

docker run
-h HOSTNAME：配置容器的主机名
--link=NAME:ALIAS：添加连接到另一个容器
-net=bridge|none|host|container:NAME_or_ID：配置容器的桥接模式
-p SPEC：映射容器端口到宿主主机
-P or --publish-all=true|false：映射容器所有端口到宿主主机
```

### 3.2 配置DNS和主机名

容器中的主机名和DNS是通过三个系统配置文件来维护的：

/etc/resolv.conf，/etc/hostname，/etc/hosts。

```
sudo docker run -it ubuntu:14.04

#mount
...
/dev/disk/by-uuid/b7001dd8-b797-4508-a5b0-dfacbb7330a0 on /etc/resolv.conf type ext4 (rw,relatime,errors=remount-ro,data=ordered)
/dev/disk/by-uuid/b7001dd8-b797-4508-a5b0-dfacbb7330a0 on /etc/hostname type ext4 (rw,relatime,errors=remount-ro,data=ordered)
/dev/disk/by-uuid/b7001dd8-b797-4508-a5b0-dfacbb7330a0 on /etc/hosts type ext4 (rw,relatime,errors=remount-ro,data=ordered)
...

root@24f7296ae8a9:/# cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 8.8.8.8
nameserver 8.8.4.4

root@24f7296ae8a9:/# cat /etc/hosts
172.17.0.6 24f7296ae8a9
127.0.0.1 localhost
::1 localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

root@24f7296ae8a9:/# cat /etc/hostname
24f7296ae8a9
```